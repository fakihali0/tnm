<story-context id="story-context" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>7</storyId>
    <title>Environment Variable Configuration and Secret Management</title>
    <status>drafted</status>
    <generatedAt>2025-11-12</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-7-environment-variable-configuration-and-secret-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>backend developer</asA>
    <iWant>all MT5 service configuration and secrets managed through environment files</iWant>
    <soThat>sensitive data stays out of version control and both backend and frontend load consistent settings</soThat>
    <tasks><![CDATA[
- Task 1: Author `.env.example` / `.env` templates for the Python service (service config, auth, Supabase, MT5, CORS) and ensure `.gitignore` continues to block secrets from Git.
- Task 2: Wire `config.py` to load/validate environment values via pydantic-settings so missing keys fail fast while logging helpful errors.
- Task 3: Document and synchronize frontend `.env.local` entries (VITE_* variables/CORS origins) so the React app can talk to the Windows MT5 host without manual tweaks.
    ]]></tasks>
  </story>

  <acceptanceCriteria><![CDATA[
1. `.env.example` lists every required backend variable (service config, auth keys, Supabase URL/service role key, MT5 pool settings, optional Redis URL, AES-256 encryption key, and CORS origins) using the structure from the epic.
2. `.env` (gitignored) contains concrete local-development values generated securely (e.g., `openssl rand -base64 32`) and mirrors the example layout.
3. `config.py` loads variables via `pydantic-settings`, validates mandatory values, and fails startup with descriptive errors if required fields are missing.
4. `.gitignore` continues to exclude `.env`/`*.env` while `.env.example` stays committed as the template.
5. `tnm_concept/.env.local` defines `VITE_MT5_SERVICE_URL`, `VITE_SUPABASE_URL`, and `VITE_SUPABASE_ANON_KEY` so the Mac frontend targets the Windows service/Supabase correctly.
  ]]></acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 1.7 Environment Variable Configuration</title>
        <section>Story 1.7</section>
        <snippet><![CDATA[The epic enumerates every backend env var required for launch (service config, Supabase secrets, MT5 pool settings, Redis placeholder, encryption key, CORS origins) plus frontend `.env.local` expectations and instructions to keep `.env` out of Git.]]></snippet>
      </doc>
      <doc>
        <path>docs/PRD-MT5-Integration-Service.md</path>
        <title>PRD §5.4 Authentication & Authorization</title>
        <section>5.4 Authentication & Authorization</section>
        <snippet><![CDATA[The PRD mandates that service-level API keys live in `MT5_SERVICE_API_KEY` env vars and be validated on every request before JWT ownership checks, reinforcing the need for centralized secret management.]]></snippet>
      </doc>
      <doc>
        <path>docs/LOCAL-DEVELOPMENT-GUIDE.md</path>
        <title>Local Development Guide</title>
        <section>Step 7: Test from Mac (.env.local)</section>
        <snippet><![CDATA[The Mac validation steps show the exact `.env.local` entries (`VITE_MT5_SERVICE_URL`, `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`) used to point the React app at the Windows service, highlighting the documentation gap this story must close.]]></snippet>
      </doc>
      <doc>
        <path>docs/LOCAL-DEVELOPMENT-GUIDE.md</path>
        <title>Local Development Guide</title>
        <section>Troubleshooting / Quick Reference</section>
        <snippet><![CDATA[Quick Reference reiterates the curl health checks, log tail commands, and firewall steps dependent on consistent env files, so updates must keep these instructions synchronized.]]></snippet>
      </doc>
      <doc>
        <path>docs/technical/WINDOWS-DEPLOYMENT-GUIDE.md</path>
        <title>Windows Deployment Guide</title>
        <section>6.2 Create Windows Service</section>
        <snippet><![CDATA[NSSM setup scripts inject `AppEnvironmentExtra` entries and rely on env vars being defined cleanly, underscoring why this story must formalize `.env` templates before migrating to services.]]></snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>.gitignore</path>
        <kind>config</kind>
        <symbol>Environment variable ignore rules</symbol>
        <lines>1-32</lines>
        <reason>The root ignore list already blocks `.env`, `.env.local`, and `*.env` patterns—story work must preserve/extend these rules while adding `.env.example` to the repo.</reason>
      </artifact>
      <artifact>
        <path>tnm_concept/src/integrations/supabase/client.ts</path>
        <kind>frontend-service</kind>
        <symbol>supabase client</symbol>
        <lines>1-22</lines>
        <reason>The generated Supabase client throws if `VITE_SUPABASE_URL` or `VITE_SUPABASE_ANON_KEY` are missing, so backend env documentation must keep these values in sync. </reason>
      </artifact>
      <artifact>
        <path>tnm_concept/src/vite-env.d.ts</path>
        <kind>type-definition</kind>
        <symbol>ImportMetaEnv</symbol>
        <lines>1-9</lines>
        <reason>This file declares the Vite env contract (`VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`), serving as the interface the story must honor for frontend configs.</reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>
        <ecosystem>node</ecosystem>
        <name>@supabase/supabase-js</name>
        <version>^2.57.4</version>
        <notes>The Supabase client consumes `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY`, so env templates must guarantee these values exist.</notes>
      </dependency>
      <dependency>
        <ecosystem>node</ecosystem>
        <name>vite</name>
        <version>^5.4.19</version>
        <notes>Vite injects `import.meta.env.*` into the frontend build; documenting `.env.local` ensures the dev server has the correct values.</notes>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints><![CDATA[
- Secrets must never be committed—use `.env.example` plus `.gitignore` to separate templates from actual values.
- Backend settings should be loaded via pydantic-settings (or equivalent) so missing/invalid env vars break fast with actionable errors.
- Maintain parity between backend `.env` keys and frontend `.env.local` keys (`VITE_*`) to avoid mismatched hostnames/CORS issues.
- Document secure key generation steps (e.g., `openssl rand -base64 32`) and remind developers to rotate production secrets outside the repo.
  ]]></constraints>

  <interfaces>
    <interface>
      <name>ImportMetaEnv</name>
      <kind>Type declaration</kind>
      <signature>interface ImportMetaEnv { VITE_SUPABASE_URL: string; VITE_SUPABASE_ANON_KEY: string; }</signature>
      <path>tnm_concept/src/vite-env.d.ts</path>
      <notes>The frontend build relies on these fields being present in `.env.local`; document any additions (e.g., `VITE_MT5_SERVICE_URL`).</notes>
    </interface>
  </interfaces>

  <tests>
    <standards><![CDATA[Manual verification per Local Development Guide: run the backend with the new env files, confirm Supabase client initialization succeeds, and ensure missing env vars raise clear errors. Automated tests will live with future Python service once the config loader is implemented.]]></standards>
    <locations><![CDATA[docs/LOCAL-DEVELOPMENT-GUIDE.md (manual validation steps); future Python service tests will reside under `app/tests/` once the backend repo is scaffolded.]]></locations>
    <ideas><![CDATA[
- [AC1] Run a linter/validator over `.env.example` to ensure every variable listed in the epic is present and documented.
- [AC2] Start the backend using the new `.env` and verify `python - <<'PY' from app.config import settings; print(settings.dict()) PY` outputs expected values, proving secure loading works.
- [AC3] Temporarily remove a required key to confirm `config.py` raises the documented error path.
- [AC5] Launch the React dev server with the updated `.env.local` and confirm Supabase requests succeed without missing-env console errors.
    ]]></ideas>
  </tests>
</story-context>
