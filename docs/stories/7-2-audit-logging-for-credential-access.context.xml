<story-context id="story-context" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>2</storyId>
    <title>Audit Logging for Credential Access</title>
    <status>drafted</status>
    <generatedAt>2025-11-12T22:04:26Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/7-2-audit-logging-for-credential-access.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>security engineer</asA>
    <iWant>structured audit logs for authentication/credential access events</iWant>
    <soThat>security incidents can be detected and investigated</soThat>
    <tasks><![CDATA[- Implement structured logger and file rotation.
- Hook API key/JWT validation to log success/failure.
- Log credential access events (decrypt, connect, delete request).
- Configure daily rotation (keep 90 days) for audit logs.
- Ensure sensitive data never logged and add alert stub for repeated failures.
- Add unit/integration tests verifying log output.]]></tasks>
  </story>

  <acceptanceCriteria><![CDATA[1. Audit logging module records authentication events in structured JSON. [Source: docs/epics.md#Story-7.2]
2. Credential access events logged with account/user IDs and IP info. [Source: docs/epics.md#Story-7.2]
3. Logs stored in `logs/audit.log` with daily rotation (keep 90 days). [Source: docs/epics.md#Story-7.2]
4. Sensitive data never logged; errors sanitized. [Source: docs/PRD-MT5-Integration-Service.md#8.2]
5. Failed authentication attempts trigger alert after 5 failures. [Source: docs/epics.md#Story-7.2]
6. Tests/manual verification confirm logging behavior. [Source: docs/epics.md#Story-7.2]]></acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 7 – Story 7.2</title>
        <section>Story 7.2</section>
        <snippet><![CDATA[Enumerates events to log, rotation requirements, and alerts.]]></snippet>
      </doc>
      <doc>
        <path>docs/PRD-MT5-Integration-Service.md</path>
        <title>PRD §8.2 Security</title>
        <section>8.2</section>
        <snippet><![CDATA[Defines structured JSON logging, retention, and sensitive data guardrails.]]></snippet>
      </doc>
      <doc>
        <path>docs/stories/3-1-api-authentication-middleware.md</path>
        <title>Story 3.1</title>
        <section>Acceptance Criteria</section>
        <snippet><![CDATA[Shows where API key/JWT validation lives for hook integration.]]></snippet>
      </doc>
      <doc>
        <path>docs/stories/7-1-aes-256-credential-encryption-implementation.context.xml</path>
        <title>Story 7.1 Context</title>
        <section>Constraints</section>
        <snippet><![CDATA[Highlights credential operations (encrypt/decrypt) that trigger audit logs.]]></snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>app/core/logger.py</path>
        <kind>module</kind>
        <symbol>get_audit_logger</symbol>
        <lines>-</lines>
        <reason><![CDATA[Defines structured JSON logger and rotation handler.]]></reason>
      </artifact>
      <artifact>
        <path>app/core/security.py</path>
        <kind>module</kind>
        <symbol>verify_api_key/verify_jwt_token</symbol>
        <lines>-</lines>
        <reason><![CDATA[Hooks log authentication events (success/failure).]]></reason>
      </artifact>
      <artifact>
        <path>supabase/functions/connect-mt5-account/index.ts</path>
        <kind>edge-function</kind>
        <symbol>connectHandler</symbol>
        <lines>-</lines>
        <reason><![CDATA[Triggers credential access logs when decrypting/storing passwords.]]></reason>
      </artifact>
      <artifact>
        <path>supabase/functions/sync-trading-data/index.ts</path>
        <kind>edge-function</kind>
        <symbol>syncHandler</symbol>
        <lines>-</lines>
        <reason><![CDATA[Logs manual sync attempts involving credential access.]]></reason>
      </artifact>
      <artifact>
        <path>tests/unit/test_audit_logging.py</path>
        <kind>test</kind>
        <symbol>test_audit_logger_output</symbol>
        <lines>-</lines>
        <reason><![CDATA[Verifies log structure and rotation behavior.]]></reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>
        <ecosystem>python</ecosystem>
        <name>logging</name>
        <version>builtin</version>
        <notes><![CDATA[Base logging framework for audit logs.]]></notes>
      </dependency>
      <dependency>
        <ecosystem>python</ecosystem>
        <name>python-json-logger (optional)</name>
        <version>latest</version>
        <notes><![CDATA[JSON formatter for audit log entries.]]></notes>
      </dependency>
      <dependency>
        <ecosystem>python</ecosystem>
        <name>logging.handlers.TimedRotatingFileHandler</name>
        <version>builtin</version>
        <notes><![CDATA[Enforces daily rotation and retention.]]></notes>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints><![CDATA[
- Avoid logging sensitive data; redact tokens/passwords.
- Keep audit log separate from application log and ensure file permissions restrict access.
- Document alert stub so future monitoring integration can hook in.
- Logging must not degrade performance; use non-blocking handlers if necessary.]]></constraints>

  <interfaces>
    <interface>
      <name>Audit log JSON schema</name>
      <kind>log format</kind>
      <signature>{ timestamp, event_type, user_id, account_id, ip_address, action, result }
      </signature>
      <path>docs/PRD-MT5-Integration-Service.md#8.2</path>
      <notes><![CDATA[Defines fields required in each audit entry.]]></notes>
    </interface>
  </interfaces>

  <tests>
    <standards><![CDATA[Unit tests verifying logger output; manual verification via tailing audit.log and ensuring rotation works.]]></standards>
    <locations><![CDATA[tests/unit/test_audit_logging.py, docs/QA/audit-logging.md]]></locations>
    <ideas><![CDATA[
- Mock logging calls to ensure structured payload.
- Simulate rapid events to confirm rotation.
- Manual QA: trigger failed logins and check log entries with redacted data.]]></ideas>
  </tests>
</story-context>
