<story-context id="story-context" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>1</storyId>
    <title>WebSocket Endpoint Implementation</title>
    <status>drafted</status>
    <generatedAt>2025-11-12T21:10:21Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/6-1-websocket-endpoint-implementation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>backend developer</asA>
    <iWant>a WebSocket endpoint that streams real-time MT5 account updates</iWant>
    <soThat>users receive push notifications when account info or positions change</soThat>
    <tasks><![CDATA[- [ ] **Task 1 (AC:1)** – Endpoint scaffolding (JWT validation, ownership checks).
- [ ] **Task 2 (AC:2)** – Connection handshake & heartbeat.
- [ ] **Task 3 (AC:3)** – Monitoring + event dispatch.
- [ ] **Task 4 (AC:4)** – Error handling (MT5 disconnects, cached fallback).
- [ ] **Task 5 (AC:5)** – Cleanup & logging.
- [ ] **Task 6 (Testing)** – Handshake, ping/pong, event emission tests.]]></tasks>
  </story>

  <acceptanceCriteria><![CDATA[1. Implement `WS /ws/account/{account_id}` validating JWT/ownership and accepting connection. [Source: docs/epics.md#Story-6.1]
2. Send connection acknowledgment, maintain heartbeat (client ping 30s, close if no ping 90s). [Source: docs/epics.md#Story-6.1]
3. Background monitoring polls MT5 every 1s and emits events for account/position changes. [Source: docs/epics.md#Story-6.1; docs/stories/4-2-update-sync-trading-data-edge-function.context.xml]
4. Handle MT5 connection loss gracefully (error message + reconnect/backoff). [Source: docs/epics.md#Story-6.1]
5. Cleanup tasks/logging on client disconnect. [Source: docs/epics.md#Story-6.1]
6. Tests/manual verification ensure flows work. [Source: docs/PRD-MT5-Integration-Service.md#5.3 WebSocket Protocol]]></acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 6 – Story 6.1</title>
        <section>Story 6.1</section>
        <snippet><![CDATA[Defines authentication, heartbeat, message types, and monitoring behavior.]]></snippet>
      </doc>
      <doc>
        <path>docs/PRD-MT5-Integration-Service.md</path>
        <title>PRD §5.3 WebSocket Protocol</title>
        <section>5.3</section>
        <snippet><![CDATA[Provides message schemas, heartbeat expectations, and error handling rules.]]></snippet>
      </doc>
      <doc>
        <path>docs/stories/4-2-update-sync-trading-data-edge-function.context.xml</path>
        <title>Story 4.2 Context</title>
        <section>Interfaces</section>
        <snippet><![CDATA[Highlights the data (account info/positions) reused for realtime updates.]]></snippet>
      </doc>
      <doc>
        <path>docs/stories/2-4-connection-state-management-and-error-handling.context.xml</path>
        <title>Story 2.4 Context</title>
        <section>Constraints</section>
        <snippet><![CDATA[Describes MT5 connection state machine and retry logic referenced by the websocket monitor.]]></snippet>
      </doc>
      <doc>
        <path>docs/stories/4-1-update-connect-mt5-account-edge-function.context.xml</path>
        <title>Story 4.1 Context</title>
        <section>Dependencies</section>
        <snippet><![CDATA[Ensures JWT/ownership validation aligns with existing auth middleware.]]></snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>app/api/routes/websocket.py</path>
        <kind>fastapi-route</kind>
        <symbol>websocket_endpoint</symbol>
        <lines>-</lines>
        <reason><![CDATA[New FastAPI route implementing the WebSocket handshake and lifecycle.]]></reason>
      </artifact>
      <artifact>
        <path>app/core/mt5_manager.py</path>
        <kind>service-module</kind>
        <symbol>MT5ConnectionManager</symbol>
        <lines>-</lines>
        <reason><![CDATA[Provides account info/position polling used in the monitoring loop.]]></reason>
      </artifact>
      <artifact>
        <path>app/services/realtime_change_detector.py</path>
        <kind>service-module</kind>
        <symbol>detect_changes</symbol>
        <lines>-</lines>
        <reason><![CDATA[Helper comparing previous/current MT5 state to emit events.]]></reason>
      </artifact>
      <artifact>
        <path>tests/api/test_websocket.py</path>
        <kind>test</kind>
        <symbol>test_websocket_endpoint</symbol>
        <lines>-</lines>
        <reason><![CDATA[FastAPI WebSocket tests verifying handshake, ping/pong, and message dispatch.]]></reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>
        <ecosystem>python</ecosystem>
        <name>FastAPI</name>
        <version>latest</version>
        <notes><![CDATA[Provides WebSocket support (`WebSocket`, `WebSocketDisconnect`).]]></notes>
      </dependency>
      <dependency>
        <ecosystem>python</ecosystem>
        <name>asyncio</name>
        <version>builtin</version>
        <notes><![CDATA[Used for background tasks, sleep intervals, and cancellation.]]></notes>
      </dependency>
      <dependency>
        <ecosystem>python</ecosystem>
        <name>psutil/logging stack</name>
        <version>latest</version>
        <notes><![CDATA[Optional metrics/logging instrumentation during monitoring.]]></notes>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints><![CDATA[
- Authentication must mirror REST security (Story 3.1) and enforce account ownership.
- Ensure only one monitor per connection; cancel tasks promptly on disconnect.
- Cap polling frequency to avoid MT5 overload; consider future throttling config.
- Document message schema so frontend hook (Story 6.2) can rely on stable structure.]]></constraints>

  <interfaces>
    <interface>
      <name>WebSocket messages</name>
      <kind>protocol</kind>
      <signature>connected, account_update, position_opened, position_closed, ping/pong</signature>
      <path>docs/PRD-MT5-Integration-Service.md#5.3</path>
      <notes><![CDATA[Defines JSON payloads consumed by clients.]]></notes>
    </interface>
  </interfaces>

  <tests>
    <standards><![CDATA[Use FastAPI WebSocket test client + pytest; manual QA with `wscat` or browser console for live verification.]]></standards>
    <locations><![CDATA[tests/api/test_websocket.py, docs/QA/websocket.md]]></locations>
    <ideas><![CDATA[
- Validate handshake (JWT required) and ownership checks.
- Simulate heartbeat failure to ensure connection closes.
- Mock MT5 responses to trigger account/position events.
- Manual test: connect via wscat and verify payloads + reconnection.]]></ideas>
  </tests>
</story-context>
