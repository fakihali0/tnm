<story-context id="story-context" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>5</storyId>
    <title>Supabase Edge Function Deployment</title>
    <status>drafted</status>
    <generatedAt>2025-11-12T14:37:45Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-5-supabase-edge-function-deployment.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>DevOps engineer</asA>
    <iWant>the updated MT5 edge functions deployed with the correct secrets and schedules</iWant>
    <soThat>production users benefit from the new connect and sync flows without manual intervention</soThat>
    <tasks><![CDATA[- [ ] **Task 1 (AC:1)** – Prepare deployment artifacts
  - [ ] Pull latest code, ensure Stories 4.1–4.4 are merged, run `supabase functions deploy connect-mt5-account` and `... sync-trading-data`.
  - [ ] Capture CLI output + dashboard status links for Dev Agent record.
- [ ] **Task 2 (AC:2)** – Secrets management
  - [ ] Run `supabase secrets set MT5_SERVICE_URL=... MT5_SERVICE_API_KEY=... ENCRYPTION_KEY=...` and document values + owners.
  - [ ] Verify secrets via `supabase secrets list` and ensure edge functions read them.
- [ ] **Task 3 (AC:3)** – Cron configuration
  - [ ] Configure `0 */5 * * *` schedule for `sync-trading-data` in Supabase dashboard; ensure enabled in staging/prod.
  - [ ] Record configuration evidence (screenshot or CLI output).
- [ ] **Task 4 (AC:4)** – Post-deploy validation
  - [ ] Invoke both functions via dashboard/CLI covering success + failure responses.
  - [ ] Tail logs for at least one sync run to confirm healthy execution.
- [ ] **Task 5 (AC:5)** – Rollback/runbook updates
  - [ ] Document rollback steps (delete functions, disable cron, restore secrets) and monitoring hooks.]]></tasks>
  </story>

  <acceptanceCriteria><![CDATA[1. `connect-mt5-account` and `sync-trading-data` are deployed via Supabase CLI (`supabase functions deploy ...`) and verified in the dashboard logs. [Source: docs/epics.md#Story-4.5; docs/PRD-MT5-Integration-Service.md#11.2-Deployment-Strategy; context7:/supabase/cli]
2. Supabase project secrets include `MT5_SERVICE_URL=https://mt5.tnm.com`, `MT5_SERVICE_API_KEY=<secure>`, and `ENCRYPTION_KEY=<32_byte_key>`; deployment notes capture where/how they were set. [Source: docs/epics.md#Story-4.5; docs/PRD-MT5-Integration-Service.md#11.3-Environment-Configuration]
3. Cron schedule `0 */5 * * *` is configured/enabled for `sync-trading-data` (Supabase Edge cron) with confirmation screenshot/log reference. [Source: docs/epics.md#Story-4.5]
4. Smoke tests run from Supabase dashboard or CLI invocations confirm success/failure responses for both functions, and logs are reviewed for errors post-deploy. [Source: docs/epics.md#Story-4.5; docs/PRD-MT5-Integration-Service.md#11.2-Deployment-Strategy]
5. Rollback procedure is documented (CLI commands, secret restoration, cron disablement) so the deployment can be reversed within minutes. [Source: docs/epics.md#Story-4.5]]]></acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 4 – Story 4.5</title>
        <section>Story 4.5</section>
        <snippet><![CDATA[Specifies deployment steps (deploy functions, set secrets, cron schedule, monitoring, rollback).]]></snippet>
      </doc>
      <doc>
        <path>docs/PRD-MT5-Integration-Service.md</path>
        <title>PRD §11.2 Deployment Strategy</title>
        <section>11.2</section>
        <snippet><![CDATA[Lists deployment sequence (Supabase functions deploy, configure secrets, run smoke tests, monitoring, rollback).]]></snippet>
      </doc>
      <doc>
        <path>docs/PRD-MT5-Integration-Service.md</path>
        <title>PRD §11.3 Environment Configuration</title>
        <section>11.3</section>
        <snippet><![CDATA[Sets required Supabase secrets (`MT5_SERVICE_URL`, `MT5_SERVICE_API_KEY`, `ENCRYPTION_KEY`) and environment parity expectations.]]></snippet>
      </doc>
      <doc>
        <path>docs/LOCAL-DEVELOPMENT-GUIDE.md</path>
        <title>Local Dev Guide</title>
        <section>Update Supabase Edge Functions</section>
        <snippet><![CDATA[Explains setting secrets, using ngrok for staging verification, and testing edge functions locally before deployment.]]></snippet>
      </doc>
      <doc>
        <path>context7:/supabase/cli</path>
        <title>Supabase CLI Docs</title>
        <section>functions deploy/serve</section>
        <snippet><![CDATA[Documents CLI commands for `functions deploy`, `functions serve`, and secret management used in Tasks 1–3.]]></snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>supabase/functions/connect-mt5-account/index.ts</path>
        <kind>edge-function</kind>
        <symbol>connectHandler</symbol>
        <lines>-</lines>
        <reason><![CDATA[One of the functions to deploy; verifying logs/secrets ensures this entry runs in production.]]></reason>
      </artifact>
      <artifact>
        <path>supabase/functions/sync-trading-data/index.ts</path>
        <kind>edge-function</kind>
        <symbol>syncHandler</symbol>
        <lines>-</lines>
        <reason><![CDATA[Requires cron scheduling and deployment; logs must be monitored post-deploy.]]></reason>
      </artifact>
      <artifact>
        <path>docs/DEPLOYMENT.md</path>
        <kind>doc</kind>
        <symbol>Deployment runbook</symbol>
        <lines>-</lines>
        <reason><![CDATA[Should be updated with CLI commands, cron configuration steps, and rollback plan.]]></reason>
      </artifact>
      <artifact>
        <path>docs/deployment-artifacts/</path>
        <kind>evidence-folder</kind>
        <symbol>screenshots/logs</symbol>
        <lines>-</lines>
        <reason><![CDATA[Storage location for CLI output, dashboard screenshots, and monitoring proof referenced in tasks.]]></reason>
      </artifact>
      <artifact>
        <path>supabase/functions/package.json</path>
        <kind>config</kind>
        <symbol>scripts</symbol>
        <lines>-</lines>
        <reason><![CDATA[Contains npm scripts for local testing or bundling prior to deployment; ensure dependencies installed before CLI steps.]]></reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>
        <ecosystem>cli</ecosystem>
        <name>Supabase CLI</name>
        <version>latest</version>
        <notes><![CDATA[Used for `functions deploy`, `functions serve`, `secrets set`, and verifying cron schedules (per Context7 docs).]]></notes>
      </dependency>
      <dependency>
        <ecosystem>platform</ecosystem>
        <name>Supabase Dashboard</name>
        <version>web</version>
        <notes><![CDATA[Configures cron jobs, monitors logs, and provides manual invocation UI required by the ACs.]]></notes>
      </dependency>
      <dependency>
        <ecosystem>monitoring</ecosystem>
        <name>UptimeRobot / Supabase Logs</name>
        <version>current</version>
        <notes><![CDATA[Used to observe health immediately after deployment; required by Dev Notes.]]></notes>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints><![CDATA[
- Deploy only after Stories 4.1–4.4 are merged and migrations applied; otherwise functions will fail due to missing schema/policies.
- Ensure secrets are set in staging before production, and never commit values to git.
- Cron schedule must match PRD (`0 */5 * * *`); document the environment (staging/prod) where it is enabled.
- Capture logs and CLI output as proof of deployment; store in `docs/deployment-artifacts/` for audit.
- Maintain a rollback plan (delete/deploy previous version, disable cron, restore secrets) and confirm it works before go-live.]]></constraints>

  <interfaces>
    <interface>
      <name>Supabase CLI – functions deploy</name>
      <kind>command</kind>
      <signature>supabase functions deploy &lt;function&gt;</signature>
      <path>context7:/supabase/cli</path>
      <notes><![CDATA[Primary deployment command; output should be captured for Dev Agent record and rollback instructions.]]></notes>
    </interface>
    <interface>
      <name>Supabase Dashboard – Cron Scheduler</name>
      <kind>UI</kind>
      <signature>Edge Functions → Schedules</signature>
      <path>docs/epics.md</path>
      <notes><![CDATA[Configure `sync-trading-data` schedule (`0 */5 * * *`), required by AC3.]]></notes>
    </interface>
  </interfaces>

  <tests>
    <standards><![CDATA[Use Supabase CLI/dash to invoke functions post-deploy, capturing logs; optionally script curl calls with service-role tokens.]]></standards>
    <locations><![CDATA[docs/deployment-artifacts/connect-function-smoke.md, docs/deployment-artifacts/sync-function-smoke.md]]></locations>
    <ideas><![CDATA[
- **AC1**: After `supabase functions deploy`, run manual invocation and record success/failure responses.
- **AC2**: Confirm `supabase secrets list` shows required keys and functions read them (e.g., log target URL).
- **AC3**: Screenshot cron schedule plus CLI/time-based verification (function triggered by scheduler).
- **AC4**: Capture Supabase logs showing at least one successful sync run and one handled failure.
- **AC5**: Simulate rollback by redeploying previous bundle or disabling cron, logging the steps.]]></ideas>
  </tests>
</story-context>
