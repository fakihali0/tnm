<story-context id="story-context" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>3</storyId>
    <title>MT5 Data Transformation Layer</title>
    <status>drafted</status>
    <generatedAt>2025-11-12T12:14:17Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-3-mt5-data-transformation-layer.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>backend developer</asA>
    <iWant>conversion functions that turn MT5-native objects into MT5-agnostic JSON dictionaries</iWant>
    <soThat>our API responses match the PRD schemas and remain consistent even if the MT5 SDK changes</soThat>
    <tasks><![CDATA[- [ ] **Task 1 (AC:1,2)** – Implement account & position transformers:
  - [ ] Add `transform_account_info(account_info)` converting MT5 AccountInfo to dict with numeric fields cast to float; return None if input is None. [Source: docs/epics.md#Story-2.3]
  - [ ] Add `transform_position(position)` that maps MT5 Position fields, adds `type_str`, and converts open time to UTC ISO plus broker ISO string. [Source: docs/epics.md#Story-2.3]
- [ ] **Task 2 (AC:4,5,6)** – Implement deal & trade aggregation:
  - [ ] Add `transform_deal(deal)` with `type_str`, entry/exit labels, UTC timestamps, and symbol normalization. [Source: docs/epics.md#Story-2.3]
  - [ ] Add `transform_history_to_trades(deals)` that groups related deals into trade records calculating duration, profit, and pips (use symbol-specific decimal logic). [Source: docs/epics.md#Story-2.3; docs/PRD-MT5-Integration-Service.md#5.2]
- [ ] **Task 3 (AC:2,6,7)** – Timezone utilities and tests:
  - [ ] Create helper to convert MT5 timestamps to timezone-aware datetimes (pytz/dateutil) and ISO strings; ensure broker offsets normalize to UTC. [Source: context7:/stub42/pytz]
  - [ ] Write unit tests covering None inputs, timezone conversion, symbol normalization, and grouping logic. [Source: docs/epics.md#Story-2.3]]]></tasks>
  </story>

  <acceptanceCriteria><![CDATA[1. `app/utils/transformers.py` exposes `transform_account_info`, `transform_position`, `transform_deal`, and `transform_history_to_trades`, returning dictionaries that match the fields specified in the epic/PRD (balance/equity, position metadata, deal details, aggregated trade records). [Source: docs/epics.md#Story-2.3; docs/PRD-MT5-Integration-Service.md#5.2]
2. Timestamps from MT5 (broker time) are converted to UTC ISO 8601 strings (e.g., `"2025-11-12T08:00:00Z"`) using timezone-aware conversions; functions handle None inputs gracefully. [Source: docs/epics.md#Story-2.3; context7:/stub42/pytz]
3. `transform_position` adds `type_str` (“buy”/“sell”) and includes both `open_time` (UTC) and `open_time_broker` (broker timezone). [Source: docs/epics.md#Story-2.3]
4. `transform_deal` normalizes deal type strings, converts timestamps, and prepares data for grouping entry/exit deals. [Source: docs/epics.md#Story-2.3]
5. `transform_history_to_trades` pairs entry/exit deals into trade objects with duration, net profit, and pips (symbol-aware). [Source: docs/epics.md#Story-2.3]
6. Symbol names are standardized (strip broker suffixes) and numeric fields cast to floats; functions return empty structures for None inputs. [Source: docs/epics.md#Story-2.3; docs/PRD-MT5-Integration-Service.md#5.2]
7. Unit tests cover happy-path and edge cases (None input, missing fields, timezone conversions). [Source: docs/epics.md#Story-2.3]]]></acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 2.3</title>
        <section>Story 2.3</section>
        <snippet><![CDATA[Defines the transformation requirements for account info, positions, deals, and trade aggregation, including timestamp handling and symbol normalization.]]></snippet>
      </doc>
      <doc>
        <path>docs/PRD-MT5-Integration-Service.md</path>
        <title>PRD JSON Schemas</title>
        <section>5.2 REST API Endpoint Specifications</section>
        <snippet><![CDATA[Provides the exact response shapes for account info, positions, and historical trades, ensuring transformers output PRD-compliant fields.]]></snippet>
      </doc>
      <doc>
        <path>docs/stories/2-2-mt5-data-retrieval-functions.context.xml</path>
        <title>Story 2.2 Context</title>
        <section>Interfaces</section>
        <snippet><![CDATA[Documents the raw MT5 retrieval helpers whose output this story consumes, keeping layers separated.]]></snippet>
      </doc>
      <doc>
        <path>docs/LOCAL-DEVELOPMENT-GUIDE.md</path>
        <title>Local Dev Guide</title>
        <section>Troubleshooting</section>
        <snippet><![CDATA[Contains real-world data expectations and logging paths, useful for verifying transformed outputs during manual checks.]]></snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>app/utils/transformers.py</path>
        <kind>utility-module</kind>
        <symbol>transform_* functions</symbol>
        <lines>-</lines>
        <reason>Main implementation target for the transformation helpers.]]></reason>
      </artifact>
      <artifact>
        <path>docs/stories/2-2-mt5-data-retrieval-functions.md</path>
        <kind>story</kind>
        <symbol>Upstream data story</symbol>
        <lines>-</lines>
        <reason>Defines the raw data structures that these transformers must accept.]]></reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>
        <ecosystem>python</ecosystem>
        <name>pytz</name>
        <version>referenced</version>
        <notes>Used for converting MT5 broker timestamps to UTC ISO strings (context7:/stub42/pytz).]]></notes>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints><![CDATA[
- Transformers must be pure functions with no MT5 dependencies; inputs come from Story 2.2 helpers.
- All timestamps normalized to UTC ISO strings while preserving broker time fields where required.
- Symbol normalization and numeric type casting should follow PRD expectations.
- Handle None/empty inputs gracefully to avoid runtime errors.]]></constraints>

  <interfaces>
    <interface>
      <name>transform_account_info</name>
      <kind>function</kind>
      <signature>transform_account_info(account_info: AccountInfo | None) -> dict | None</signature>
      <path>app/utils/transformers.py</path>
      <notes>Produces PRD-aligned account info dictionaries or None.]]></notes>
    </interface>
    <interface>
      <name>transform_history_to_trades</name>
      <kind>function</kind>
      <signature>transform_history_to_trades(deals: list[dict]) -> list[dict]</signature>
      <path>app/utils/transformers.py</path>
      <notes>Groups entry/exit deals, computing trade metrics like net profit and duration.]]></notes>
    </interface>
  </interfaces>

  <tests>
    <standards><![CDATA[Unit tests should feed synthetic MT5 objects/dicts into each transformer, verifying field mapping, timezone conversion, symbol normalization, and grouping logic.]]></standards>
    <locations><![CDATA[tests/test_transformers.py (new)]]></locations>
    <ideas><![CDATA[
- Provide sample AccountInfo objects and assert floats/fields match PRD schema.
- Feed positions with broker timestamps and verify UTC/broker ISO outputs.
- Simulate entry/exit deal pairs to ensure trade grouping produces correct duration and pips.
- Test None/empty inputs to confirm graceful handling.]]></ideas>
  </tests>
</story-context>
