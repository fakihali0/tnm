<story-context id="story-context" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>1</storyId>
    <title>AES-256 Credential Encryption Implementation</title>
    <status>drafted</status>
    <generatedAt>2025-11-12T22:02:17Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/7-1-aes-256-credential-encryption-implementation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>security engineer</asA>
    <iWant>MT5 account passwords encrypted/decrypted via AES-256 helpers</iWant>
    <soThat>credentials are never stored or transmitted in plain text</soThat>
    <tasks><![CDATA[- [ ] Implement AES-256 `encrypt_password` helper with random IV.
- [ ] Implement `decrypt_password` helper with error handling.
- [ ] Load/validate `ENCRYPTION_KEY` (32 bytes) from env and never log it.
- [ ] Update code paths (connect edge function, sync, etc.) to use helpers before storing/decrypting credentials.
- [ ] Add unit tests verifying roundtrip and invalid inputs.
- [ ] Document key generation/rotation steps.]]></tasks>
  </story>

  <acceptanceCriteria><![CDATA[1. Implement `encrypt_password` using AES-256 (CBC/GCM), random IV, base64 `iv + ciphertext`. [Source: docs/epics.md#Story-7.1; docs/PRD-MT5-Integration-Service.md#8.2]
2. Implement `decrypt_password` reversing the process and raising errors on failure. [Source: docs/epics.md#Story-7.1]
3. Key loaded from `ENCRYPTION_KEY` env var (32 bytes), never logged; config enforces length. [Source: docs/epics.md#Story-7.1; docs/stories/1-7-environment-variable-configuration-and-secret-management.md]
4. `account_integrations` stores encrypted passwords only; connect/sync flows use helpers. [Source: docs/epics.md#Story-7.1; docs/stories/4-1..., 4-2...]
5. Unit tests verify roundtrip and invalid payload handling. [Source: docs/epics.md#Story-7.1]
6. Logs/telemetry never include secrets. [Source: docs/PRD-MT5-Integration-Service.md#8.2]]></acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 7 – Story 7.1</title>
        <section>Story 7.1</section>
        <snippet><![CDATA[Defines AES-256 requirements (helpers, env key, tests).]]></snippet>
      </doc>
      <doc>
        <path>docs/PRD-MT5-Integration-Service.md</path>
        <title>PRD §8.2 Security Requirements</title>
        <section>8.2</section>
        <snippet><![CDATA[Specifies encryption standard, key management, and logging rules.]]></snippet>
      </doc>
      <doc>
        <path>docs/stories/1-7-environment-variable-configuration-and-secret-management.md</path>
        <title>Story 1.7</title>
        <section>Acceptance Criteria</section>
        <snippet><![CDATA[Details env variable structure and key generation instructions.]]></snippet>
      </doc>
      <doc>
        <path>docs/stories/4-1-update-connect-mt5-account-edge-function.context.xml</path>
        <title>Story 4.1 Context</title>
        <section>Interfaces</section>
        <snippet><![CDATA[Confirms connect flow uses encrypted credentials stored in Supabase.]]></snippet>
      </doc>
      <doc>
        <path>docs/stories/4-2-update-sync-trading-data-edge-function.context.xml</path>
        <title>Story 4.2 Context</title>
        <section>Constraints</section>
        <snippet><![CDATA[Highlights where decrypted credentials are needed during sync, ensuring helpers integrate correctly.]]></snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>app/core/security.py</path>
        <kind>module</kind>
        <symbol>encrypt_password/decrypt_password</symbol>
        <lines>-</lines>
        <reason><![CDATA[Implementation location for AES-256 helpers.]]></reason>
      </artifact>
      <artifact>
        <path>app/core/config.py</path>
        <kind>config</kind>
        <symbol>settings.ENCRYPTION_KEY</symbol>
        <lines>-</lines>
        <reason><![CDATA[Loads and validates environment key (32 bytes).]]></reason>
      </artifact>
      <artifact>
        <path>supabase/functions/connect-mt5-account/index.ts</path>
        <kind>edge-function</kind>
        <symbol>connectHandler</symbol>
        <lines>-</lines>
        <reason><![CDATA[After this story, edge function should call encrypt helper before storing credentials.]]></reason>
      </artifact>
      <artifact>
        <path>supabase/functions/sync-trading-data/index.ts</path>
        <kind>edge-function</kind>
        <symbol>syncHandler</symbol>
        <lines>-</lines>
        <reason><![CDATA[Needs to decrypt credentials using helper before login.]]></reason>
      </artifact>
      <artifact>
        <path>tests/unit/test_crypto.py</path>
        <kind>test</kind>
        <symbol>test_encrypt_decrypt_roundtrip</symbol>
        <lines>-</lines>
        <reason><![CDATA[Unit tests verifying helper behavior.]]></reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>
        <ecosystem>python</ecosystem>
        <name>cryptography</name>
        <version>latest</version>
        <notes><![CDATA[Provides AES-256 primitives (Cipher, algorithms, modes).]]></notes>
      </dependency>
      <dependency>
        <ecosystem>python</ecosystem>
        <name>base64</name>
        <version>builtin</version>
        <notes><![CDATA[Used to encode IV + ciphertext.]]></notes>
      </dependency>
      <dependency>
        <ecosystem>python</ecosystem>
        <name>os/secrets</name>
        <version>builtin</version>
        <notes><![CDATA[Generates random IVs securely.]]></notes>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints><![CDATA[
- Key must be 32 bytes; fail fast if missing/invalid.
- Avoid logging plaintext, keys, or raw ciphertext.
- Use env-driven key; document rotation process (e.g., restart service after key change).
- Raise descriptive exceptions when decryption fails to aid debugging without leaking sensitive info.]]></constraints>

  <interfaces>
    <interface>
      <name>encrypt_password/decrypt_password</name>
      <kind>function</kind>
      <signature>encrypt_password(plain: str, key: bytes) -> str; decrypt_password(token: str, key: bytes) -> str</signature>
      <path>app/core/security.py</path>
      <notes><![CDATA[Helpers consumed by edge functions and backend code.]]></notes>
    </interface>
  </interfaces>

  <tests>
    <standards><![CDATA[Use pytest with cryptography library; include negative tests (bad key, tampered payload).]]></standards>
    <locations><![CDATA[tests/unit/test_crypto.py]]></locations>
    <ideas><![CDATA[
- Roundtrip encryption/decryption with sample key.
- Tamper ciphertext to ensure exception.
- Validate base64 format parsing.
- Manual QA: generate key via `openssl rand -base64 32`, run CLI script verifying helper.]]></ideas>
  </tests>
</story-context>
